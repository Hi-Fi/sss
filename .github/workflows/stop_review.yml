name: Stop Review
on:
  pull_request:
    types: [closed]

jobs:
  stop_review:
    if:  github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    name: Stop Review
    steps:
      - name: Authenticate to GCP
        id: auth
        uses: google-github-actions/auth@8d125895b958610ec414ca4dae010257eaa814d3 # tag=v0
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Remove review version
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT }}
        run: gcloud app versions delete pr-${{ github.event.pull_request.number }} -q

      - name: Disable frontend review environment
        uses: strumwolf/delete-deployment-environment@45c821e46baa405e25410700fe2e9643929706a0 # tag=v2.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: PR-${{ github.event.pull_request.number }}
          onlyRemoveDeployments: true

      - name: Disable print review environment
        uses: strumwolf/delete-deployment-environment@45c821e46baa405e25410700fe2e9643929706a0 # tag=v2.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: PR-${{ github.event.pull_request.number }}-print
          onlyRemoveDeployments: true

      - name: Disable core review environment
        uses: strumwolf/delete-deployment-environment@45c821e46baa405e25410700fe2e9643929706a0 # tag=v2.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: PR-${{ github.event.pull_request.number }}-core
          onlyRemoveDeployments: true
