name: Stop Review
on:
  pull_request:
    types: [closed]

jobs:
  stop_review:
    if:  github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    name: Stop Review
    steps:
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@04141d8a7edfc8c679682f23e7bbbe05cbe32bb3
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Remove review version
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT }}
        run: gcloud app versions delete pr-${{ github.event.pull_request.number }} -q

      - name: Disable frontend review environment
        uses: strumwolf/delete-deployment-environment@8c399c0d0b63616fd8a5b94c7e6e3e052136555e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: PR-${{ github.event.pull_request.number }}
          onlyRemoveDeployments: true

      - name: Disable print review environment
        uses: strumwolf/delete-deployment-environment@8c399c0d0b63616fd8a5b94c7e6e3e052136555e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: PR-${{ github.event.pull_request.number }}-print
          onlyRemoveDeployments: true

      - name: Disable core review environment
        uses: strumwolf/delete-deployment-environment@8c399c0d0b63616fd8a5b94c7e6e3e052136555e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: PR-${{ github.event.pull_request.number }}-core
          onlyRemoveDeployments: true
